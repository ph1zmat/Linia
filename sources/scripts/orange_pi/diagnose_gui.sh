#!/bin/bash

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ GUI –æ–∫—Ä—É–∂–µ–Ω–∏—è

echo "=== –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ GUI –æ–∫—Ä—É–∂–µ–Ω–∏—è ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
echo "üñ•Ô∏è  –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã: $(uname -m)"
echo "üêß –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é DISPLAY
if [ -z "$DISPLAY" ]; then
    echo "‚ùå DISPLAY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ X —Å–µ—Å—Å–∏–∏
    echo "üîç –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö X —Å–µ—Å—Å–∏–π:"
    ps aux | grep -E "(Xorg|X)" | grep -v grep
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º systemd services
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É–∂–±:"
    systemctl is-active display-manager 2>/dev/null || echo "Display manager –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    systemctl is-active gdm 2>/dev/null || echo "GDM –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    systemctl is-active lightdm 2>/dev/null || echo "LightDM –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    systemctl is-active sddm 2>/dev/null || echo "SDDM –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    
else
    echo "‚úÖ DISPLAY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $DISPLAY"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å X —Å–µ—Ä–≤–µ—Ä–∞
    if command -v xset &> /dev/null; then
        if xset q &>/dev/null; then
            echo "‚úÖ X —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"
            xset q | head -5
        else
            echo "‚ùå X —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        fi
    else
        echo "‚ùå –£—Ç–∏–ª–∏—Ç–∞ xset –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install x11-utils"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ X11 forwarding
if [ ! -z "$SSH_CLIENT" ] || [ ! -z "$SSH_TTY" ]; then
    echo "üîó –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"
    if [ ! -z "$DISPLAY" ]; then
        echo "‚úÖ X11 forwarding –∞–∫—Ç–∏–≤–µ–Ω"
    else
        echo "‚ùå X11 forwarding –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ssh -X –∏–ª–∏ ssh -Y"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ GUI –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
echo "üìö –ü—Ä–æ–≤–µ—Ä–∫–∞ GUI –±–∏–±–ª–∏–æ—Ç–µ–∫:"
ldconfig -p | grep -E "(gtk|qt|wx)" | head -10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
EXEC_PATH="../../generated/Linia2/Linia2"
if [ -f "$EXEC_PATH" ]; then
    echo "‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: $EXEC_PATH"
    echo "üîç –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ (–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ):"
    ldd "$EXEC_PATH" | grep -E "(gtk|gdk|wx|X11)" | head -10
else
    echo "‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $EXEC_PATH"
fi

echo ""
echo "=== –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ==="

if [ -z "$DISPLAY" ]; then
    echo "1. üñ•Ô∏è  –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞: –≤–æ–π–¥–∏—Ç–µ –≤ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é —Å–µ—Å—Å–∏—é KDE"
    echo "2. üåê –î–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ SSH:"
    echo "   ssh -X –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@orangepi_ip"
    echo "   ssh -Y –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@orangepi_ip  # –¥–ª—è trusted connections"
    echo "3. üñºÔ∏è  –î–ª—è VNC: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ VNC —Å–µ—Ä–≤–µ—Ä"
    echo "4. üñºÔ∏è  –î–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –¥–∏—Å–ø–ª–µ—è:"
    echo "   sudo apt install xvfb"
    echo "   export DISPLAY=:99"
    echo "   Xvfb :99 -screen 0 1024x768x16 &"
fi

if [ "$(whoami)" = "root" ]; then
    echo "‚ö†Ô∏è  –í—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –æ—Ç root. –î–ª—è GUI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    echo "   –ï—Å–ª–∏ –Ω—É–∂–µ–Ω root –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Å–ø–ª–µ—é: xhost +local:root"
fi
