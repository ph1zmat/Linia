#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ GUI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Linia2 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏—Å–ø–ª–µ—è

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ GUI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–∞ –ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Å GUI
if [ -z "$DISPLAY" ]; then
    echo "‚ö†Ô∏è  DISPLAY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å..."
    
    # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É—é X11 —Å–µ—Å—Å–∏—é
    DISPLAY_NUM=$(ps aux | grep Xorg | grep -v grep | head -1 | sed 's/.*:\([0-9]\+\).*/\1/')
    
    if [ ! -z "$DISPLAY_NUM" ]; then
        export DISPLAY=:$DISPLAY_NUM
        echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω DISPLAY=:$DISPLAY_NUM"
    else
        echo "‚ùå –ê–∫—Ç–∏–≤–Ω–∞—è X11 —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo "–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
        echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"
        echo "2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ SSH —Å —Ñ–ª–∞–≥–æ–º -X: ssh -X user@orangepi"
        echo "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VNC –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–±–æ—á–µ–º—É —Å—Ç–æ–ª—É"
        echo "4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π X —Å–µ—Ä–≤–µ—Ä: sudo apt install xvfb && export DISPLAY=:99 && Xvfb :99 -screen 0 1024x768x16 &"
        exit 1
    fi
fi

echo "‚úÖ DISPLAY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $DISPLAY"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å X —Å–µ—Ä–≤–µ—Ä–∞
if ! xset q &>/dev/null; then
    echo "‚ùå X —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
    echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –æ–±–æ–ª–æ—á–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞"
    echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ X —Å–µ—Å—Å–∏–∏: xhost +local:"
    echo "3. –î–ª—è SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ssh -X –∏–ª–∏ ssh -Y"
    exit 1
fi

echo "‚úÖ X —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º
cd "$(dirname "$0")/../../generated/Linia2" || {
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º: ../../generated/Linia2"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
if [ ! -f "./Linia2" ]; then
    echo "‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª Linia2 –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞: ./full_build_arm64.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
if [ ! -f "CIC.loc" ] && [ -f "../../../files/Linia.loc" ]; then
    echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª..."
    cp "../../../files/Linia.loc" "./CIC.loc"
fi

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Linia2..."
echo "–ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª: $(pwd)/Linia2"
echo "DISPLAY: $DISPLAY"

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
./Linia2

echo "üèÅ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
